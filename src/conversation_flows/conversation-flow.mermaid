flowchart TD
%% ğŸŒŸ Visual Legend with Shape Identifiers
subgraph Legend["ğŸŒŸ Visual Legend"]
    A(["ğŸ” Permissions Required"]) --> Ainfo["Rectangular Node"]
    B(["ğŸ‘¤ User Profile"]) --> Binfo["Rectangular Node"]
    C{{"ğŸš¨ Red Alert-Initiated"}} --> Cinfo["Diamond Decision"]
    D(["ğŸ§­ Emergency Checklist"]) --> Dinfo["Rectangular Node"]
    E(["ğŸ§  Stress Check"]) --> Einfo["Rounded Node"]
    F["ğŸŒ€ CALMe Activity Menu"] --> Finfo["Subgraph Module"]
    G["ğŸ¤ Emotional Support"] --> Ginfo["Subgraph Module"]
    H((("ğŸŸ£ End / Closure"))) --> Hinfo["Circle Terminator"]
end

%% ğŸ”’ Permissions & Profile
Permissions("ğŸ” Permissions Required") --> Profile("ğŸ‘¤ User Profile Setup")
Profile --> Greeting["ğŸ‘‹ Hello. I'm here with you.<br>Are you physically safe right now?"]

%% ğŸš¦ App Launch Type
Greeting --> LaunchType{"How was the app launched?"}
LaunchType --> UserLaunch("ğŸ§‘â€ğŸ’» User-Initiated")
LaunchType --> AlertLaunch("ğŸš¨ Red Alert-Initiated")

%% ğŸ§­ Shared Emergency Checklist
UserLaunch --> Checklist["ğŸ§­ Emergency Checklist"]
AlertLaunch --> Checklist
Checklist --> SafeStatus{"Are you in a protected space?"}
SafeStatus -->|No| Unsafe("ğŸ”´ Unsafe")
SafeStatus -->|Yes| StressStart("ğŸ§  Let's check your stress level")

%% â¤ï¸ Unsafe Flow: Empathetic Guidance
Unsafe --> EncourageSafe("ğŸ’¬ Please get to the nearest safe place.<br>I am here with you every step.")
EncourageSafe --> StressStart

%% âš¡ Red Alert-Initiated Branch
AlertLaunch --> Detection("âš¡ Home Front Command Alert Detected")
Detection --> Countdown("â° 90-second Countdown Begins")
Countdown --> AudioPrompt("ğŸ”ˆ 'Red alert. Get to safety now.'"):::rounded
AudioPrompt --> AppScreen("ğŸ“± CALMe App Auto-Launches")
AppScreen --> SafeQuery{"ğŸ  Are you in your safe space?"}

SafeQuery -->|Yes| ConfirmSafe("âœ… Safe Confirmed")
ConfirmSafe --> SilenceOtherAlerts("ğŸ”• Silencing alerts")
SilenceOtherAlerts --> BeginCalming("ğŸ§ Start calming audio & breathing guide")
BeginCalming --> StressStart

SafeQuery -->|No| GuideToSafety("ğŸš¶ Keep moving to safetyâ€”I will guide you")
GuideToSafety --> Checklist

SafeQuery -->|Can't reach| ContinueAlert("ğŸ”Š Alerts continue + location-specific instructions")

%% ğŸ—ºï¸ Location-Specific Emergency Guidance
SafeQuery --> Transit("ğŸš— I'm in a vehicle"):::rounded
Transit --> CanExit{"Can you reach shelter safely?"}
CanExit -->|Yes| TransitSteps("ğŸƒ Exit vehicle<br>Beyond curb<br>Lie down & cover head")
CanExit -->|No| TransitStay("ğŸš˜ Stay in vehicle<br>Open windows<br>Duck below windows<br>Protect head")
TransitSteps --> StressStart
TransitStay --> StressStart

SafeQuery --> OpenSpace("ğŸ—ï¸ Outdoors / Construction site")
OpenSpace --> OpenSpaceCheck{"Do you have shelter or gear nearby?"}
OpenSpaceCheck -->|Yes| OpenPrep("ğŸ›¡ï¸ Prepare to enter shelter or gear")
OpenSpaceCheck -->|No| OpenLieDown("ğŸ§ Lie down and shield head during alert")
OpenPrep --> StressStart
OpenLieDown --> StressStart

SafeQuery --> CareFacility("ğŸ¥ Care Facility or Caregiver")
CareFacility --> CanMoveResidents{"Can you move residents to safety?"}
CanMoveResidents -->|Yes| CareMove("ğŸšª Guide residents to reinforced shelter calmly")
CanMoveResidents -->|No| CareStay("ğŸ§“ Stay with them<br>Protect head<br>Offer verbal reassurance")
CareMove --> StressStart
CareStay --> StressStart

SafeQuery --> HomeLocation("ğŸ  Home with Protected Room")
HomeLocation --> StressStart

%% ğŸ§  Stress Pathway Alignment
StressStart:::rounded --> HS("ğŸ”´ High Stress")
StressStart --> MS("ğŸŸ¡ Moderate Stress")
StressStart --> LS("ğŸ”µ Low Stress")
StressStart --> NS("âšª No Stress")

HS --> HS1("ğŸ§ Grounding: Press feet into the floor")
HS1 --> HS2("ğŸŒ¬ï¸ Breathing: In 4â€¦ Hold 7â€¦ Out 8")
HS2 --> HS3{"Need emotional support services?"}
HS3 -->|Yes| ERAN("â˜ï¸ ERAN Crisis Hotline")
HS3 -->|No| HighCalmMenu("ğŸ§ CALMe Activity Menu")

MS --> MS1("ğŸ§© Structure what happened")
MS1 --> MS2("ğŸ—£ï¸ Describe step-by-step")
MS2 --> MS3("ğŸŒŠ Feelings come and goâ€”like waves")
MS3 --> ModCalmMenu("ğŸ¶ Music / Grounding Activity")

LS --> LS1("ğŸ˜ Feeling slightly unsettled")
LS1 --> LS2{"Would you like a calming activity?"}
LS2 -->|Yes| LowCalmMenu("ğŸ§˜ CALMe Activities")
LS2 -->|No| LS3("ğŸ’¬ You're welcome back any time"):::rounded

NS --> NS1("âœ… All clear. Thanks for checking in.")
NS1 --> NS2{"Try a light activity?"}
NS2 -->|Yes| NSActivity("ğŸ§© Music / Drawing / Story")
NS2 -->|No| NSEnd("ğŸŒ Have a peaceful day")

%% ğŸŒ€ CALMe Activity Modules (Shared Across)
HighCalmMenu --> CalmMenu
ModCalmMenu --> CalmMenu
LowCalmMenu --> CalmMenu
NSActivity --> CalmMenu

subgraph CalmMenu["ğŸŒ€ CALMe Activity Menu"]
    BreathModule("Breathing")
    GameModule("Match Game")
    GroundModule("5-4-3-2-1 Grounding")
    MusicModule("ğŸµ Relaxing Music")
    DrawingModule("ğŸ¨ Creative Drawing")
    StoryModule("ğŸ“– Calming Story")
end
CalmMenu --> FinalEnd(("ğŸŸ£ End / Closure"))

%% ğŸ«± Shared Support Services
ERAN --> SupportModule
subgraph SupportModule["ğŸ¤ Emotional Support"]
    KeepOlim("ğŸ’™ KeepOlim Mental Health")
    Tikva("ğŸ“ Tikva 24/7 Emotional Hotline")
    MentalHealthHotline("ğŸ§  Ministry of Health Crisis Line")
end

%% ğŸ¨ Style Definitions
classDef alertFlow fill:#ffecb3,stroke:#f57c00,stroke-width:2px,shape:pentagon
class AlertLaunch alertFlow
